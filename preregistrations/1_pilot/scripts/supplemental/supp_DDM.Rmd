---
title: "supp_DDM"
author: "Stefan Vermeent"
date: "8-12-2021"
output: html_document
---


# Libraries 

```{r}
library(tidyverse)
library(here)
library(magrittr)
library(glue)
```



# Load data

```{r}
load(here("data", "1_pilot", "1_task_data_clean.Rdata"))
load(here("data", "1_pilot", "2_cleaned_data.Rdata"))
```


# EZDM Estimation

Does it matter whether Mean RT and RT variance are estimated based on correct trials only or the combination of correct and incorrect trials?

```{r}
supp_change_EZ_data <- change_data_clean_average %>%
  rename(
    rt_change_correct     = rt_change,
    rt_var_change_correct = rt_var_change) %>%
  left_join(
      change_data_clean_average %>% select(change_data_long) %>%
        unnest() %>%
        mutate(rt = rt/1000) %>%
        group_by(id) %>%
        summarise(
          rt_change_all = mean(rt, na.rm = T),
          rt_var_change_all = sd(rt, na.rm = T)^2 
        )
    ) %>%
  mutate(acc_change = ifelse(acc_change == 1, 1-(1/(2*50)), acc_change))

change_EZDM_results_correcttrials <- 
  pmap(supp_change_EZ_data[c("acc_change", "rt_var_change_correct", "rt_change_correct", "id")], function(acc_change,rt_var_change_correct,rt_change_correct, id) {
    
    EZ_fit <- Data2EZ(Pc = acc_change, VRT = rt_var_change_correct, MRT = rt_change_correct, s = 1) %>%
      as_tibble() %>%
      mutate(id = id)
  }) %>%
  bind_rows %>%
  select(id, change_EZ_v_correct = v, change_EZ_a_correct = a, change_EZ_t0_correct = Ter)

change_EZDM_results_alltrials <- 
  pmap(supp_change_EZ_data[c("acc_change", "rt_var_change_all", "rt_change_all", "id")], function(acc_change,rt_var_change_all,rt_change_all, id) {
    
    EZ_fit <- Data2EZ(Pc = acc_change, VRT = rt_var_change_all, MRT = rt_change_all, s = 1) %>%
      as_tibble() %>%
      mutate(id = id)
  }) %>%
  bind_rows %>%
  select(id, change_EZ_v_all = v, change_EZ_a_all = a, change_EZ_t0_all = Ter)
```
      
```{r fig.height = 10, fig.width = 8}

supp_change_DDM_params <- left_join(change_EZDM_results_alltrials, change_EZDM_results_correcttrials) %>%
  left_join(cleaned_data %>% select(id, matches("change_ml_(bad_fit|v|a|t0)")))

ggplot(supp_change_DDM_params, aes(change_EZ_a_correct, change_ml_a, color = change_ml_bad_fit)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)

ggplot(supp_change_DDM_params, aes(change_EZ_t0_correct, change_ml_t0, color = change_ml_bad_fit)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)

ggplot(supp_change_DDM_params, aes(change_EZ_t0_correct, change_EZ_t0_all, color = change_ml_bad_fit)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)
```



# Attention Cueing

```{r}
cueing_ddm_data <- cleaned_data %>%
  select(id, starts_with(c("rt_cueing", "acc_cueing")), starts_with("cueing"), event_during_cueing, scale_factor, counterbalance, meta_resolution_height, meta_resolution_ratio, meta_feedback, cueing_data_long, -cueing_ml_fit) 
```


```{r, fig.height = 8, fig.width = 8}
cleaned_data %>%
  select(starts_with("cueing"), -cueing_data_long, -cueing_ml_fit) %>%
  cor(use = "complete.obs") %>% 
  corrplot(method = "number")
```

```{r}
cueing_ddm_data %>%
  select(id, matches("EZ")) %>%
  pivot_longer(matches("EZ"), names_to = "parameter", values_to = "value") %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~parameter, scales = "free")
```

Some subjects have a negative non-decision time, which should not be possible. These might be the same people who are in the tail of the boundary separation distribution.

```{r}
cueing_ddm_data %>%
  ggplot(aes(cueing_cued_EZ_t0, cueing_cued_EZ_a)) +
  geom_point()

cueing_ddm_data %>%
  ggplot(aes(cueing_neutral_EZ_t0, cueing_neutral_EZ_a)) +
  geom_point()
```

Indeed, the people with t0 values below or close to zero also have the highest boundary separation. Is there anything that sets these participants apart?

```{r}
cueing_ddm_data %<>%
  mutate(
    high_a = factor(ifelse(cueing_neutral_EZ_a > 2, TRUE, FALSE))
  ) %>%
  drop_na(high_a)

ggplot(cueing_ddm_data, aes(high_a, rt_cueing_cued)) +
  geom_boxplot()

ggplot(cueing_ddm_data, aes(high_a, rt_cueing_neutral)) +
  geom_boxplot()

ggplot(cueing_ddm_data, aes(high_a, acc_cueing_cued)) +
  geom_boxplot() +
  geom_jitter(width = 0.15)

ggplot(cueing_ddm_data, aes(high_a, acc_cueing_neutral)) +
  geom_boxplot() +
  geom_jitter(width = 0.15)


ggplot(cueing_ddm_data, aes(acc_cueing_cued, rt_cueing_cued, color = cueing_cued_EZ_a)) +
  geom_jitter(width = 0.005)

ggplot(cueing_ddm_data, aes(acc_cueing_neutral, rt_cueing_neutral, color = cueing_neutral_EZ_a)) +
  geom_jitter(width = 0.005)



ggplot(cueing_ddm_data, aes(acc_cueing_neutral, acc_cueing_cued, color = cueing_neutral_EZ_a)) +
  geom_jitter(width = 0.008, height = 0.008)

ggplot(cueing_ddm_data, aes(rt_cueing_neutral, rt_cueing_cued, color = cueing_neutral_EZ_a)) +
  geom_jitter(width = 0.005)
```
Subjects with extremely high boundary separations are almost exclusively subjects with high accuracy and high reaction times in both conditions.

```{r}
ggplot(cueing_ddm_data, aes(cueing_neutral_EZ_a, meta_resolution_height)) +
  geom_point()

ggplot(cueing_ddm_data, aes(cueing_neutral_EZ_a, meta_resolution_ratio)) +
  geom_point()

ggplot(cueing_ddm_data, aes(cueing_neutral_EZ_a, scale_factor)) +
  geom_point()
```
```{r}
cueing_ddm_data_long <- cueing_ddm_data %>%
  #filter(high_a == TRUE) %>%
  select(high_a, cueing_data_long) %>%
  unnest() 

cueing_ddm_data_long %>%
  ggplot(aes(rt, fill = factor(id))) +
  geom_histogram() +
  facet_wrap(~id) +
  guides(fill = "none")

cueing_ddm_data_long %>%
  group_by(id, high_a) %>%
  summarise(sum(rt > 2000)) %>% View

```



