---
title: "primary_hypotheses"
author: "Stefan Vermeent"
date: "24-11-2021"
output:
  word_document: default
  html_document: default
---

```{r}
library(tidyverse)
library(here)
library(broom)
library(performance)
library(lme4)
library(lmerTest)
library(GPArotation)
library(psych)
library(nFactors)
library(flextable)
library(magrittr)
library(ggeffects)


change_data_clean <- read_csv(here("data", "1_pilot", "change_data_clean.csv"))
cueing_data_clean <- read_csv(here("data", "1_pilot", "cueing_data_clean.csv"))
flanker_data_clean <- read_csv(here("data", "1_pilot", "flanker_data_clean.csv"))
self_report_clean <- read_csv(here("data", "1_pilot", "self_report_clean.csv"))

codebook <- read_csv(here("data", "1_pilot", "pilot_self_report_codebook.csv"))

# Create datasets with mean RTs and accuracy 
change_data_clean_mean <- change_data_clean %>%
  group_by(id) %>%
  summarise(rt_change = mean(rt, na.rm = T), acc_change = (sum(correct) / n()) * 100) %>%
  ungroup() %>%
  left_join(self_report_clean %>% select(id, matches("(total|composite|mean)$")))

cueing_data_clean_mean <- cueing_data_clean %>%
  group_by(id, condition) %>%
  summarise(rt_cueing = mean(rt, na.rm = T), acc_cueing = (sum(correct) / n()) * 100) %>%
  ungroup() %>%
  mutate(
    condition = ifelse(condition == "neutral", -1, 1),
    rt_cueing = scale(rt_cueing)
  ) %>%
  left_join(self_report_clean %>% select(id, matches("(total|composite|mean)$")))

flanker_data_clean_mean <- flanker_data_clean %>%
  group_by(id, congruency) %>%
  summarise(rt_flanker = mean(rt, na.rm = T), acc_flanker = (sum(correct) / n()) * 100) %>%
  ungroup() %>%
  mutate(
    congruency = ifelse(congruency == "congruent", -1, 1),
    rt_flanker = scale(rt_flanker)
  ) %>%
  left_join(self_report_clean %>% select(id, matches("(total|composite|mean)$")))
```


# 1. Primary hypotheses - Effect of violence exposure on task performance

## Reaction Times

### Change Detection Task

The mean accuracy across participants on the Change Detection Task was *M* = `r round(mean(change_data_clean_mean$acc_change),2)` (*SD* = `r round(sd(change_data_clean_mean$acc_change),2)`). Therefore, we also conducted an analysis on the mean accuracy.

```{r fig.height = 10, fig.width = 12}
model_change_rt_vio <- lm(data = change_data_clean_mean, log(rt_change) ~ violence_composite) 
summary(model_change_rt_vio)

check_model(model_change_rt_vio)
```

```{r fig.height = 10, fig.width = 12}
model_change_acc_vio <- lm(data = change_data_clean_mean, log(acc_change) ~ violence_composite) 
summary(model_change_acc_vio)

check_model(model_change_acc_vio)
```



### Attention Cueing Task

```{r fig.height = 10, fig.width = 12}
cueing_data_clean_mean %<>%
  filter(!id %in% c("269", "32", "37"))

model_cueing_rt_vio <- lmer(data = cueing_data_clean_mean, rt_cueing ~ violence_composite*condition + (1|id)) 
summary(model_cueing_rt_vio)



check_model(model_cueing_rt_vio)
```


### Flanker Task

```{r fig.height = 10, fig.width = 12}
model_flanker_rt_vio <- lmer(data = flanker_data_clean_mean, rt_flanker ~ violence_composite*congruency + (1|id)) 
summary(model_flanker_rt_vio)

ggpredict(model_flanker_rt_vio, terms = c("composite_composite [-1,1]", "congruency [-1,1]"))

check_model(model_flanker_rt_vio)
```


# 2. Primary hypotheses - Factor structure of unpredictability measures

We conducted an EFA including all items measuring unpredictability: 1) The QUIC items, 2) the perceived unpredictability items, 3) the CHAOS items, 4) the items measuring environmental change, 5) number of partners of the father and mother, 6) Number of residential changes, 7) household size. 

The measures of residential changes and number of different partners of both parents were heavily positively skewed.

```{r}
self_report_clean %>%
  select(id, unp_partners_father, unp_partners_mother, unp_household_size, unp_moving) %>%
  pivot_longer(starts_with("unp_"), names_to = "var", values_to = "value") %>%
  ggplot() +
  geom_histogram(aes(value)) +
  facet_wrap(~var, scales = "free")
```

Two participants indicated 50 different partners for either their mother or father. This number corresponded with other items focusing on the family situation, such as on the QUIC ("At least one of my parents had many romantic partners") and changes in the family environment. Therefore, we saw no reason to exclude these responses. We binned the responses for these three variables to get rid of the skew. For number of residential changes, responses were recoded into 7 bins: 0 (0 times), 1 (1-2 times), 2 (3-4 times), 3 (5-6 times), 4 (7-8 times), 5 (9-10 times), and 6 (10 or more times). For the number of partners of both parents, responses were recoded into .. bins: 0 (0 partners), 1 (1 partner), 2 (2 partners), 3 (3 partners), 4 (4 partners), 5 (5 partners), and 6 (6 or more partners).

```{r}
self_report_clean %<>%
  mutate(
    unp_moving_binned = case_when(
      unp_moving == 0 ~ 0,
      unp_moving %in% c(1,2) ~ 1,
      unp_moving %in% c(3,4) ~ 2,
      unp_moving %in% c(5,6) ~ 3,
      unp_moving %in% c(7,8) ~ 4,
      unp_moving %in% c(9,10) ~ 5,
      unp_moving > 10 ~ 6,
    ),
    unp_partners_mother_binned = case_when(
      unp_partners_mother == 0 ~ 0,
      unp_partners_mother == 1 ~ 1,
      unp_partners_mother == 2 ~ 2,
      unp_partners_mother == 3 ~ 3,
      unp_partners_mother == 4 ~ 4,
      unp_partners_mother == 5 ~ 5,
      unp_partners_mother >= 6 ~ 6,
    ),
    unp_partners_father_binned = case_when(
      unp_partners_father == 0 ~ 0,
      unp_partners_father == 1 ~ 1,
      unp_partners_father == 2 ~ 2,
      unp_partners_father == 3 ~ 3,
      unp_partners_father == 4 ~ 4,
      unp_partners_father == 5 ~ 5,
      unp_partners_father >= 6 ~ 6,
    )
  )
```

```{r}
self_report_clean %>%
  select(id, unp_partners_father_binned, unp_partners_mother_binned, unp_household_size, unp_moving_binned) %>%
  pivot_longer(starts_with("unp_"), names_to = "var", values_to = "value") %>%
  ggplot() +
  geom_histogram(aes(value)) +
  facet_wrap(~var, scales = "free")
```


```{r}
efa_data <- self_report_clean %>%
  select(matches("(quic\\d\\d)|(unp\\d\\d)|(chaos\\d\\d)|(change_env\\d\\d)"), 
         unp_partners_father_binned, unp_partners_mother_binned, unp_household_size, unp_moving_binned) %>%
  drop_na() %>%
  mutate(across(matches("quic(01|02|03|04|05|06|07|08|09|11|14|16|22|32)"), ~ 6 - .)) %>%
  mutate(across(matches("chaos(01|02|04|07|12|14|15)"), ~ 6 - .))
```

First, we determine the number of factors through parallel analysis, with the added constraint that each factor should have at least 5 items that have their highest loading on that factor. Parallel analysis suggests extracting 5 factors.

```{r}
ev <- eigen(cor(efa_data)) # get eigenvalues
ap <- parallel(subject=nrow(efa_data),var=ncol(efa_data),
  rep=100,cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS)
```
```{r}
efa_model <- factanal(efa_data, factors = 5, rotation = "oblimin")

efa_model

tidy(efa_model) %>% 
  mutate(across(starts_with("fl"), ~ifelse(. < .32, NA, .))) %>% 
  left_join(codebook %>% rename(variable = Variable)) %>% 
  arrange(fl1, fl2, fl3, fl4, fl5) %>% 
  mutate(
    Label = case_when(
      variable == "unp_moving_binned" ~ "Residential changes", 
      variable == "unp_partners_father_binned" ~ "Romantic partners - father", 
      variable == "unp_partners_mother_binned" ~ "Romantic partners - mother", 
      variable == "unp_household_size" ~ "Household size",
      variable == "unp03" ~ "My parents had a difficult divorce or separation during this time.",
      TRUE ~ Label
  ),
    variable = case_when(
      str_detect(variable, "quic") ~ "QUIC - ",
      str_detect(variable, "unp\\d\\d") ~ "Perceived - ",
      str_detect(variable, "chaos") ~ "CHAOS - ",
      str_detect(variable, "change_env") ~ "Changes - ",
      TRUE ~ ""
    )
  ) %>% 
  unite(col = "Item", c(variable, Label), sep = "") %>%
  select(Item, fl1, fl2, fl3, fl4, fl5) %>% 
  mutate(across(starts_with("fl"), ~round(., 2))) %>%
  rename(
    `1` = fl1,
    `2` = fl2,
    `3` = fl3,
    `4` = fl4,
    `5` = fl5
  ) %>%
  flextable(cwidth = c(5, .6,.6,.6,.6,.6))
  
 
```

