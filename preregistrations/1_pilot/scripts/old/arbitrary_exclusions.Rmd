---
title: "arbitrary_exclusions"
author: "Stefan Vermeent"
date: "23-11-2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(glue)
library(magrittr)

self_report_clean <- read_csv(here("data", "1_pilot", "self_report_clean.csv"))
change_data_clean_mean <- read_csv(here("data", "1_pilot", "change_data_clean_mean.csv"))
cueing_data_clean_mean <- read_csv(here("data", "1_pilot", "cueing_data_clean_mean.csv"))
flanker_data_clean_mean <- read_csv(here("data", "1_pilot", "flanker_data_clean_mean.csv"))

source(here("preregistrations", "1_pilot", "scripts", "decision_grids_tasks.R"))

suspect_browser_interactions <- self_report_clean %>%
  select(id, blur_event, fullscreenenter, fullscreenexit, focus_event) %>%
  filter(blur_event > 0 | fullscreenexit > 0)

browser_interactions <- read_csv(here("data", "1_pilot", "browser_interactions.csv"))

theme_set(
  theme_light() +
    theme(
    #  text = element_text(family="Lato"),
      panel.grid = element_blank()
    )
)
```

# Overview of arbitrary exclusion criteria for the attention tasks

| Criteria names              | Description                                                                               |
|-------------------------------------------------------------------------------------------------------------------------|
| ex_arb_low_res              | Subjects with small screen resolutions for whom the experiment might have been too large. |
| ex_arb_no_resize            | Subjects who did not go through the resizing procedure.                                   |
| ex_arb_no_fullscreen        | Subjects who did not enter fullscreen mode at the start of the attention tasks.           |
| ex_arb_exit_fullscreen      | Subjects who exited fullscreen mode during the attention tasks.                           |
| ex_arb_event_during_change  | Subjects with blur events during the Change Detection Task.                               |
| ex_arb_event_during_cueing  | Subjects with blur events during the Attention Cueing Task.                               |
| ex_arb_event_during_flanker | SUbjects with blur events during the Flanker Task.                                        |
| ex_arb_captcha              | Subjects who had missing data on  or failed the bot detection                             | 
| ex_arb_interrupt            | Subjects who were interrupted during the experiment.                                      |
| ex_arb_noise                | Subjects who performed the cognitive tasks in a noisy environment.                        |



```{r}
create_multiverse <- function(data, grid, grid_keys) {
  
  multiverse <- grid %>%
    rownames_to_column("decision") %>%
    split(.$decision) %>%
    map(.f = function(x) {
      
      # Take all the decisions of current split and turn them into a vector
      decision_x <- x %>% select(-decision) %>% as_vector
      
       # Filter data based on evaluated exclusions
      final_filter <- data
      walk(decision_x, function(y) {
        final_filter <<- 
          final_filter %>% 
          filter(eval(parse(text = y)))
      })
      
      # Store the decisions
      decisions <- x %>%
        pivot_longer(starts_with("ex_arb"), names_to = "variable", values_to = "exp") %>%
        left_join(grid_keys, by = c("variable" = "variable", "exp" = "exp"))
      
      list(
        n         = nrow(final_filter),
        data      = final_filter %>% mutate(decision = x$decision),
        decisions = decisions
      )
    })
}
```



# Sample size per dataset

```{r}
multiverse_samplesize_plots <- function(multiverse_object, group_by = across()) {
  
  multiverse_sample_size <- 
    map_df(multiverse_object, function(x){
      # Grab the decisions flatten them out
      decisions <- x$decisions %>% 
        pivot_longer(c(exp, variable_group, name), names_to="key", values_to="value") %>%
        unite(grid_vars, variable, key) %>% 
        pivot_wider(names_from = "grid_vars", values_from = "value")
      # Add the decisions to the model table
      bind_cols(n = x$n, decisions)
    })
  # histogram of sample sizes in the multiverse
  multiverse_sample_size %>% 
    ggplot(aes(x = n)) +
    geom_histogram(color = "black", bins = 15) +
    labs(title = "Histogram of Multiverse Sample Sizes", x = "\nSample Size", y = "Number of Datasets\n")
  
  multiverse_sample_size %>% 
    select(-ends_with("exp")) %>% 
    pivot_longer(starts_with("ex_arb"), names_to = "variable", values_to = "exclusion") %>%
    mutate(variable = str_replace(variable, "_(name)$|_(variable_group)$", ".\\1\\2")) %>% 
    separate(variable, c("var","group"), sep = "\\.") %>% 
    pivot_wider(names_from = "group", values_from = "exclusion") %>%
    arrange(decision, variable_group) %>% 
    ggplot() +
    geom_boxplot(aes(x = name, y = n), notch = T, width = .5)  +
    scale_x_discrete("Exclusion Criteria") +
    scale_y_continuous("Sample Size (max = 495)\n") +
    ggtitle("Sample Sizes in the Multiverse") +
    facet_wrap(~variable_group, scales = "free", ncol = 2)
}
```


```{r, fig.width = 15}
multiverse_descriptives <- function(multiverse_object, vars, condition = "", plot_thinning = 0) {

  evens <- function(x, step_size) {
    if(step_size > 0) {
      subset(x, x %% step_size == 0)
    } else {
      return(x)
    }}
  
  multiverse_performance <- 
    map(multiverse_object, function(x) {
      data <- x$data %>%
        select(decision, id, matches(vars))
      
      decisions <- x$decisions %>%
        pivot_longer(c(exp, variable_group, name), names_to = "key", values_to = "value") %>%
        unite(grid_vars, variable, key) %>%
        pivot_wider(names_from = grid_vars, values_from = value)
      
      data %<>% left_join(decisions, by = "decision")  
    }) %>%
    bind_rows %>%
    pivot_longer(matches(vars), names_to = "key", values_to = "value") %>%
    #group_by(across(c(decision, key, starts_with("ex_arb")))) %>%
    #summarise(
    #  mean = mean(value, na.rm = T),
    #  sd   = sd(value, na.rm = T)
   # ) %>%
    group_by(across(matches("decision", "key", condition))) %>% 
    mutate(
      median = median(value),
      median = ifelse(str_detect(key, "^rt_.*$"), NA, median)) %>%
    group_by(decision) %>%
    fill(median, .direction = "updown") %>%
    group_by(key) %>%
    mutate(multiverse_set = as.numeric(fct_reorder(decision, median))) %>%
    ungroup() %>%
    mutate(value = ifelse(multiverse_set %in% evens(x = unique(.$multiverse_set), step_size = plot_thinning), value, NA))
  
  multiverse_plot <-   
    ggplot(multiverse_performance, aes(x = as.numeric(multiverse_set), y = value, group = multiverse_set)) +
    geom_boxplot() +
   # geom_point(size = .5) +
    # geom_errorbar(
    #   aes(x = as.numeric(multiverse_set), ymin = mean - sd, ymax = mean + sd),
    #   size = .25,
    #   width = 0,
    #   alpha = .25, 
    #   inherit.aes = F, 
    #   show.legend = T
    # ) +
    theme_classic() +
    facet_wrap(key~., scales = "free") +
    scale_y_continuous("Estimate") +
    scale_color_manual(values = c("gray","#f0506e")) +
    scale_fill_manual(values = c("gray","#f0506e")) +
    theme(
      axis.text.x = element_blank(), 
      axis.title.x = element_blank(),
      axis.ticks.x = element_blank()
    )
  
  multiverse_specgrid <- 
    multiverse_performance %>%
    select(-matches("exp$"), -c(id, value, median, decision)) %>%
    distinct() %>%
    pivot_longer(matches("name$|group$"), names_to = "variable", values_to = "spec") %>%
    mutate(variable = str_replace(variable, "_(name$)|_(variable_group$)",".\\1\\2")) %>% 
    separate(variable, c("variable","group"), sep = "\\.") %>% 
    pivot_wider(names_from = "group", values_from = "spec") %>%
    ggplot(aes(x = multiverse_set, y = name)) +
    geom_point(size = .75, shape = 124, show.legend = F) +
    scale_y_discrete("Specification\n") +
    scale_x_continuous("\nMultiverse Dataset") +
    scale_color_manual(values = c("gray","#f0506e")) +
    facet_grid(variable_group~key, scales = "free_y") +
    theme(strip.background.x = element_blank(), strip.text.x = element_blank(), strip.placement = "outside")
  
  cowplot::plot_grid(
    multiverse_plot,
    multiverse_specgrid,
    ncol = 1, 
    align = 'v', 
    axis = "lr",
    rel_heights = c(.30,.70)
  )
}
```



# Multiverse 1: Change Detection Task

```{r, fig.width = 12}
change_multiverse <- create_multiverse(data = change_data_clean_mean, grid = decision_grid_change, grid_keys = decision_grid_change_key)
multiverse_samplesize_plots(change_multiverse)
change_multiverse_plot <- multiverse_descriptives(multiverse_object = change_multiverse, vars = c("^acc_"), plot_thinning = 2)
```


# Multiverse 2: Attention Cueing Task

```{r, fig.width = 12}
cueing_multiverse <- create_multiverse(data = cueing_data_clean_mean, grid = decision_grid_cueing, grid_keys = decision_grid_cueing_key)
multiverse_samplesize_plots(cueing_multiverse)
cueing_multiverse_plot <- multiverse_descriptives(multiverse_object = cueing_multiverse, vars = c("^acc_"), plot_thinning = 2)
```


# Multiverse 3: Flanker Task

```{r, fig.width = 12}
flanker_multiverse <- create_multiverse(data = flanker_data_clean_mean, grid = decision_grid_flanker, grid_keys = decision_grid_flanker_key)
multiverse_samplesize_plots(flanker_multiverse)
flanker_multiverse_plot <- multiverse_descriptives(flanker_multiverse, c("^acc_"), plot_thinning = 2)
```






```{r, fig.width = 15, fig.height = 6}
plot_browser_interactions <- function(data, id) {
  
  colors = c("blur" = "orange", "focus" = "blue", "fullscreenenter" = "green", "fullscreenexit" = "red")
  
  for(i in id) {
    
    (data %>%
       filter(id == i) %>%  
       ggplot(aes(time, color = event, fill = event)) + 
       geom_rect(aes(xmin = min(time_start_change_block1), xmax = min(time_end_change_block1), ymin=0, ymax=1), fill = "lightblue", color = "black") +
       geom_rect(aes(xmin = min(time_start_change_block2), xmax = min(time_end_change_block2), ymin=0, ymax=1), fill = "lightblue", color = "black") +
       geom_rect(aes(xmin = min(time_start_cueing_data), xmax = min(time_end_cueing_data), ymin=0, ymax=1), fill = "lightpink", color = "black") +
       geom_rect(aes(xmin = min(time_start_flanker_data), xmax = min(time_end_flanker_data), ymin=0, ymax=1), fill = "lightgreen", color = "black") +
       geom_text(aes(x = (min(time_start_change_block1)+min(time_end_change_block2))/2, y = 1.05, label = "Change"), color = "black") +
       geom_text(aes(x = (min(time_start_cueing_data)+min(time_end_cueing_data))/2, y = 1.05, label = "Cueing"), color = "black") +
       geom_text(aes(x = (min(time_start_flanker_data)+min(time_end_flanker_data))/2, y = 1.05, label = "Flanker"), color = "black") +
       scale_fill_manual(values=colors) +
       scale_color_manual(values=colors) +
       geom_bar(width = 2, alpha=0.5, position="dodge") +
       theme_classic() +
       theme(
         axis.ticks.y = element_blank(),
         axis.text.y = element_blank()
       ) +
       labs(
         x = "Time",
         y = "",
         title = "Browser Interaction Events During the Cognitive Tasks",
         subtitle = "Blur = interacting with other webpages; Focus = Refocusing on the task browser."
       ) +
       guides(color="none")) %>% print
  }
}


plot_browser_interactions(data= browser_interactions, id = c(515, 494, 158, 280, 6, 189, 528))
```

## Change Detection Task

```{r}



decision_grid_change <- expand_grid(
  ex_arb_low_res_pass              = c(TRUE, FALSE),         
  ex_arb_no_resize_pass            = c(TRUE, FALSE),
  ex_arb_no_fullscreen_pass        = c(TRUE, FALSE),
  ex_arb_exit_fullscreen_pass      = c(TRUE, FALSE),
  ex_arb_event_during_change_pass  = c(TRUE, FALSE)
)

exclusion_fun <- function(ex_arb_low_res_pass, ex_arb_no_resize_pass, ex_arb_no_fullscreen_pass, ex_arb_exit_fullscreen_pass, ex_arb_event_during_change_pass) {
  data <- change_data_clean_mean %>%
      filter(
        isTRUE(ex_arb_low_res) | (isTRUE(ex_arb_low_res) & isFALSE(ex_arb_low_res_pass)) | (isFALSE(ex_arb_low_res) & isTRUE(ex_arb_low_res_pass)),
        isTRUE(ex_arb_no_resize) | (isTRUE(ex_arb_no_resize) & isFALSE(ex_arb_no_resize_pass)) | (isFALSE(ex_arb_no_resize) & isTRUE(ex_arb_no_resize_pass)),
        isTRUE(ex_arb_no_fullscreen) | (isTRUE(ex_arb_no_fullscreen) & isFALSE(ex_arb_no_fullscreen_pass)) | (isFALSE(ex_arb_no_fullscreen) & isTRUE(ex_arb_no_fullscreen_pass)),
        isTRUE(ex_arb_exit_fullscreen) | (isTRUE(ex_arb_exit_fullscreen) & isFALSE(ex_arb_exit_fullscreen_pass)) | (isFALSE(ex_arb_exit_fullscreen) & isTRUE(ex_arb_exit_fullscreen_pass)),
        isTRUE(ex_arb_event_during_change) | (isTRUE(ex_arb_event_during_change) & isFALSE(ex_arb_event_during_change_pass)) | (isFALSE(ex_arb_event_during_change) & isTRUE(ex_arb_event_during_change_pass)),
      )
}


pmap(decision_grid_change, exclusion_fun)


multiverse_change <- decision_grid_change %>%
  #rownames_to_column("decision") %>%
 # split(.$decision) %>%
  pmap(.f = function(x) {
    data <- change_data_clean_mean %>%
      filter(
        ex_arb_low_res              == x$ex_arb_low_res &
        ex_arb_no_resize            == x$ex_arb_no_resize &
        ex_arb_no_fullscreen        == x$ex_arb_no_fullscreen &
        ex_arb_exit_fullscreen      == x$ex_arb_exit_fullscreen &
        ex_arb_event_during_change  == x$ex_arb_event_during_change
      )
  })
  
```

