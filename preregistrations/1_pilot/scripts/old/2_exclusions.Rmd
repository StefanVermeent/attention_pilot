---
title: "2_exclusions"
author: "Stefan Vermeent"
output: html_document
---

```{r setup, results=F}
library(tidyverse)
library(here)
library(magrittr)

self_report <- read_csv(here("data", "1_pilot", "pilot_self_report.csv"))
change_data <- read_csv(here("data", "1_pilot", "change_data.csv"))
flanker_data <- read_csv(here("data", "1_pilot", "flanker_data.csv"))
cueing_data <- read_csv(here("data", "1_pilot", "cueing_data.csv"))

source(here("preregistrations", "1_pilot", "scripts", "custom_functions", "functions_exclusions.R"))

# Exclusions and data fixes based on subject feedback
misc_exclusions <- readxl::read_xlsx(here("data", "1_pilot", "misc_exclusions.xlsx"))
```

# Planned Exclusions

## Self-report measures

Here, we compute exclusion variables relating to the various attention items.
```{r}
self_report_clean <- self_report %>%
  mutate(
    # Attention checks in the questionnaires - Arbitrary exclusion choices
    ex_narb_attention_checks_pass     = ifelse(attention_check_sum == 2, FALSE, TRUE),
    # Participants with all questionnaires missing - Non-arbitrary exclusion choice
    ex_narb_NA_selfreport_pass  = if_any(ends_with(c("total", "mean")), ~!is.na(.)),
  )
```

Beyond subjects who had missing data on all questionnaires, we investigate missingness patterns for the other subjects.

```{r}
self_report_clean %>%
  filter(ex_narb_NA_selfreport_pass) %>%
  select(id, ends_with("missing")) %>%
  filter(if_any(-id, ~ . > 0)) %>%
  pivot_longer(-id, names_to = "Scale", values_to = "missing") %>%
  ggplot(aes(Scale, missing, color = factor(id), group = factor(id))) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  scale_y_continuous(breaks=seq(0, 40, 2)) +
  labs(
    y = "# missing items"
  )
```
Subject 369 has missing responses on the majority of items across all questionnaires. Therefore, we exclude this participant from the analyses.

```{r}
self_report_clean %<>%
  mutate(ex_narb_NA_selfreport_pass = ifelse(id == "369", FALSE, ex_narb_NA_selfreport_pass))
```

Finally, we check for suspicious response patterns by looking at standard deviations in non-recoded items. If people consistently select the same response despite the inclusion of recoded items, this might indicate that they did not fill out the questionnaires seriously. We exclude the perceived unpredictability scale and the BIS because they do not contain recoded items, thus making an SD = 0 likely.

```{r}
low_q_SDs <- self_report_clean %>%
  filter(ex_narb_NA_selfreport_pass) %>%
  select(id, starts_with("sd_"), -sd_unp, -sd_impuls) %>%
  filter(if_any(starts_with("sd_"), ~ . == 0)) %>%
  pivot_longer(-id, names_to = "Scale", values_to = "SD") %>%
  group_by(id) %>%
  summarise(n = sum(SD == 0))

low_q_SDs %>% filter(n > 0)
```

A total of `r nrow(low_q_SDs)` subjects had an SD = 0 on at least one questionnaire. Of these, `r nrow(low_q_SDs %>% filter(n>1))` subjects have more than one SD = 0 (min = `r min(low_q_SDs$n)`, max = `r max(low_q_SDs$n)`). We did not preregister a strict cut-off to determine what constitutes a "suspicious response pattern". An SD of 0 on two or more questionnaires is arguably reason for exclusion. However, with only one SD = 0 it becomes more arbitrary, and might depend partly on the specific questionnaire in question (e.g., an SD of 0 on the QUIC with 37 items is more suspicious than an SD of 0 on the perceived SES measure with only one recoded item out of seven). Thus, we create two exclusion variables: An non-arbitrary exclusion variable for more than 2 SDs of 0, and an arbitrary exclusion variable for subjects with 1 SD of 0.

```{r}
self_report_clean %<>%
  left_join(
    low_q_SDs %>%
      mutate(
        ex_narb_suspect_responses_pass = ifelse(n > 1, FALSE, TRUE),
        ex_arb_suspect_responses = TRUE
      ) %>%
      select(-n)
    ) %>%
  # Set exclusion variables for suspect responses to TRUE for all other participants
  mutate(
    ex_narb_suspect_responses_pass = ifelse(is.na(ex_narb_suspect_responses_pass), TRUE, ex_narb_suspect_responses_pass),
    ex_arb_suspect_responses  = ifelse(is.na(ex_arb_suspect_responses), TRUE, ex_arb_suspect_responses),
  )
```

## Reaction Times

### Change Detection Task

```{r}
# Cleaning the RT data by removing extremely short and long RTs, as well as log-transformed outliers
change_data_clean <- 
  change_data %>%
  group_by(id) %>%
  mutate(
    acc_change                        = (sum(correct, na.rm=T)/n())*100,
    ex_narb_change_acc_cutoff         = ifelse(acc_change < gbinom(50, 0.50), FALSE, TRUE),
    ex_narb_change_rowcount           = n(),
    ex_narb_change_NA_trials          = ifelse(n() > 1, sum(is.na(rt)), NA), 
    ex_narb_change_log_outliers       = ifelse(n() > 1, sum(scale(log(rt)) > 3.2), NA),
    ex_narb_change_invalid_trials     = ifelse(n() > 1, sum(rt > 3500 | rt < 250, na.rm = TRUE), NA),
  ) %>%
  ungroup()
```

### Flanker Task

```{r}
# Cleaning the RT data by removing extremely short and long RTs, as well as log-transformed outliers per condition
flanker_data_clean <- 
  flanker_data %>%
  group_by(id, congruency) %>%
  mutate(acc_flanker = (sum(correct, na.rm=T)/n())*100) %>%
  group_by(id) %>%
  mutate(
    ex_narb_flanker_acc_cutoff         = ifelse(acc_flanker < gbinom(32, 0.50), FALSE, TRUE),
    ex_narb_flanker_rowcount           = n(),
    ex_narb_flanker_NA_trials          = ifelse(n() > 1, sum(is.na(rt)), NA), 
    ex_narb_flanker_log_outliers       = ifelse(n() > 1, sum(scale(log(rt)) > 3.2), NA),
    ex_narb_flanker_invalid_trials     = ifelse(n() > 1, sum(rt > 3500 | rt < 250, na.rm = TRUE), NA),
  ) %>% 
  ungroup()
```

### Cueing Task

```{r}
# Cleaning the RT data by removing extremely short and long RTs, as well as log-transformed outliers per condition
cueing_data_clean <- 
  cueing_data %>%
  group_by(id, condition) %>%
  mutate(acc_cueing = (sum(correct, na.rm=T)/n())*100) %>%
  group_by(id) %>%
  mutate(
    ex_narb_cueing_acc_cutoff         = ifelse(acc_cueing < gbinom(32, 0.50), FALSE, TRUE),
    ex_narb_cueing_rowcount           = n(),
    ex_narb_cueing_NA_trials          = ifelse(n() > 1, sum(is.na(rt)), NA), 
    ex_narb_cueing_log_outliers       = ifelse(n() > 1, sum(scale(log(rt)) > 3.2), NA),
    ex_narb_cueing_invalid_trials     = ifelse(n() > 1, sum(rt > 3500 | rt < 250, na.rm = TRUE), NA),
  ) 
```

# Overview of Non-Arbitrary Decisions

```{r}
non_arbitrary_exclusions <- 
  left_join(
    self_report_clean %>%
      select(id, starts_with("ex_narb_")),
    # Join Attention Task exclusions
    reduce(
      ls() %>% str_subset("(cueing|change|flanker)_data_clean$") %>% map(function(x) {
        eval(as.symbol(x)) %>%
          select(id, starts_with("ex_narb_")) %>%
          distinct() 
      }),
      left_join)
  ) %>%
  mutate(
    # Exclusions based on self-reported technical issues
    ex_narb_tasks_technicalissues_pass  = ifelse(id %in% unique(misc_exclusions$id), FALSE, TRUE),
    
    ex_narb_change_pass                 = ifelse(across(matches("ex_narb_change_(NA_trials|log_outliers|invalid_trials)")) %>% rowSums(., na.rm = TRUE) > 10 | ex_narb_change_rowcount == 1, F, T),
    ex_narb_cueing_pass                 = ifelse(across(matches("ex_narb_cueing_(NA_trials|log_outliers|invalid_trials)")) %>% rowSums(., na.rm = TRUE) > 10 | ex_narb_cueing_rowcount ==2, F, T),
    ex_narb_flanker_pass                = ifelse(across(matches("ex_narb_flanker_(NA_trials|log_outliers|invalid_trials)")) %>% rowSums(., na.rm = TRUE) > 10 | ex_narb_flanker_rowcount == 2, F, T)
  ) %>%
  mutate(
    # Total number of non-arbitrary checks passed
    n_failed = across(  ends_with("_pass")) %>% rowSums(., na.rm = T)
  )
```
```{r}
non_arbitrary_exclusions %>%
  count(n_failed)
```

A total of `r sum(non_arbitrary_exclusions$n_failed < 7)` subjects failed at least one of the non-arbitrary exclusion criteria.


# Apply data exclusions

```{r}
ids_to_retain <- non_arbitrary_exclusions %>% filter(n_failed == max(n_failed)) %>% pull(id)

change_data_clean  %<>% 
  group_by(id) %>% 
  filter(
    id %in% ids_to_retain, 
    rt > 250 & rt < 3500, 
    scale(log(rt)) < 3.2, 
    ex_narb_change_acc_cutoff==TRUE,
  ) %>% 
  ungroup()

cueing_data_clean  %<>% 
  group_by(id) %>% 
  filter(  
    rt > 250 & rt < 3500, 
    scale(log(rt)) < 3.2, 
    ex_narb_cueing_acc_cutoff==TRUE) %>% 
  # Make sure everyone has two conditions left
  filter(length(unique(condition)) == 2) %>%
  ungroup()

flanker_data_clean %<>% 
  group_by(id) %>% 
  filter(
    id %in% ids_to_retain, 
    rt > 250 & rt < 3500, 
    scale(log(rt)) < 3.2, 
    ex_narb_flanker_acc_cutoff==TRUE) %>% 
  # make sure everyone has two conditions left
  filter(length(unique(congruency)) == 2) %>%
  ungroup()


self_report_clean  %<>% group_by(id) %>% filter(id %in% ids_to_retain) %>% ungroup()

# # Sanity checks
# if(length(unique(change_data_clean$id)) != length(unique(flanker_data_clean$id))) warning("The Change data and Flanker data have a different sample size.")
# if(length(unique(change_data_clean$id)) != length(unique(cueing_data_clean$id))) warning("The Change data and Cueing data have a different sample size.")
# if(length(unique(flanker_data_clean$id)) != length(unique(cueing_data_clean$id))) warning("The Flanker data and Cueing data have a different sample size.")
# if(length(unique(change_data_clean$id)) != length(unique(self_report_clean$id))) warning("The Change data and self-report data have a different sample size.")
# if(length(unique(cueing_data_clean$id)) != length(unique(self_report_clean$id))) warning("The Cueing data and self-report data have a different sample size.")
# if(length(unique(flanker_data_clean$id)) != length(unique(self_report_clean$id))) warning("The Flanker data and self-report data have a different sample size.")
```

Sanity check: Did the correct number of trials get removed for each participant?

```{r}
if(nrow(cueing_data_clean %>% group_by(id) %>% mutate(check = ifelse(64 - (ex_narb_cueing_log_outliers + ex_narb_cueing_invalid_trials) == n(), TRUE, FALSE)) %>% filter(isFALSE(check))) > 1) {
   warning("Something went wrong with the removal of trials for the Flanker Task. Either too few or too many trials were removed for some subjects.")
}

if(nrow(change_data_clean %>% group_by(id) %>% mutate(check = ifelse(50 - (ex_narb_change_log_outliers + ex_narb_change_invalid_trials) == n(), TRUE, FALSE)) %>% filter(isFALSE(check))) > 1) {
   warning("Something went wrong with the removal of trials for the Flanker Task. Either too few or too many trials were removed for some subjects.")
}

if(nrow(flanker_data_clean %>% group_by(id) %>% mutate(check = ifelse(64 - (ex_narb_flanker_log_outliers + ex_narb_flanker_invalid_trials) == n(), TRUE, FALSE)) %>% filter(isFALSE(check))) > 1) {
   warning("Something went wrong with the removal of trials for the Flanker Task. Either too few or too many trials were removed for some subjects.")
}
```


```{r}
cueing_data_clean %>%
  group_by(id) %>%
  summarise(n=n()) %>%
  ggplot(aes(n)) +
  geom_histogram() +
  scale_x_continuous(breaks=seq(54, 64, 1)) +
  labs(title="Number of trials after exclusions on the Cueing Task")

flanker_data_clean %>%
  group_by(id) %>%
  summarise(n=n()) %>%
  ggplot(aes(n)) +
  geom_histogram() +
  scale_x_continuous(breaks=seq(54, 64, 1)) +
  labs(title="Number of trials after exclusions on the Flanker Task")

change_data_clean %>%
  group_by(id) %>%
  summarise(n=n()) %>%
  ggplot(aes(n)) +
  geom_histogram() +
  scale_x_continuous(breaks=seq(40,50, 1)) +
  labs(title="Number of trials after exclusions on the Change Task")
```


```{r}
# Create datasets with mean RTs and accuracy 
change_data_clean_mean <- change_data_clean %>%
  group_by(id, correct) %>%
  mutate(rt_change = ifelse(correct, mean(rt, na.rm = T), NA)) %>%
  group_by(id) %>%
  summarise(rt_change = mean(rt_change, na.rm = T), acc_change = (sum(correct) / n()) * 100) %>%
  ungroup() %>%
  left_join(self_report_clean %>% 
              select(id, 
                     starts_with(c("meta", "att")), 
                     matches("(total|composite|mean)$"),
                     scale_factor, fullscreenenter, fullscreenexit, event_during_change, attention_interrupt_sum))

cueing_data_clean_mean <- cueing_data_clean %>%
  group_by(id, condition, correct) %>%
  # RT for correct trials
  mutate(rt_cueing = ifelse(correct, mean(rt, na.rm = T), NA)) %>%
  group_by(id, condition) %>%
  summarise(rt_cueing = mean(rt_cueing, na.rm = T), acc_cueing = (sum(correct) / n()) * 100) %>%
  left_join(self_report_clean %>% 
              select(id, 
                     starts_with(c("meta", "att")), 
                     matches("(total|composite|mean)$"),
                     scale_factor, fullscreenenter, fullscreenexit, event_during_cueing, attention_interrupt_sum))

flanker_data_clean_mean <- flanker_data_clean %>%
 group_by(id, congruency, correct) %>%
  mutate(rt_flanker = ifelse(correct, mean(rt, na.rm = T), NA)) %>%
  group_by(id, congruency) %>%
  summarise(rt_flanker = mean(rt_flanker, na.rm = T), acc_flanker = (sum(correct) / n()) * 100) %>%
  left_join(self_report_clean %>% 
              select(id, 
                     starts_with(c("meta", "att")), 
                     matches("(total|composite|mean)$"),
                     scale_factor, fullscreenenter, fullscreenexit, event_during_flanker, attention_interrupt_sum))
```



```{r}
write_csv(change_data_clean, here("data", "1_pilot", "change_data_clean.csv"))
write_csv(cueing_data_clean, here("data", "1_pilot", "cueing_data_clean.csv"))
write_csv(flanker_data_clean, here("data", "1_pilot", "flanker_data_clean.csv"))

write_csv(cueing_data_clean_mean, here("data", "1_pilot", "cueing_data_clean_mean.csv"))
write_csv(change_data_clean_mean, here("data", "1_pilot", "change_data_clean_mean.csv"))
write_csv(flanker_data_clean_mean, here("data", "1_pilot", "flanker_data_clean_mean.csv"))

write_csv(self_report_clean, here("data", "1_pilot", "self_report_clean.csv"))

save(non_arbitrary_exclusions, file = here("data", "1_pilot", "exclusions_nonarbitrary.RData"))
```

